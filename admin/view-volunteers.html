<!DOCTYPE html>
<html>
<head>
  <title>View Applications | SevaSphere</title>

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background:#f4f7fb;
      padding:30px;
    }

    h2 {
      color:#1e6091;
    }

    .event-block {
      background:white;
      padding:20px;
      border-radius:15px;
      margin-bottom:25px;
      box-shadow:0 5px 15px rgba(0,0,0,0.08);
    }

    .app-card {
      background:#eef6fb;
      padding:15px;
      border-radius:10px;
      margin-top:10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .name-link {
      font-weight:600;
      color:#1e6091;
      cursor:pointer;
    }

    .btn {
      padding:6px 12px;
      border:none;
      border-radius:8px;
      cursor:pointer;
      font-weight:600;
      margin-left:8px;
    }

    .accept { background:#52b69a; color:white; }
    .reject { background:#ef4444; color:white; }
  </style>
</head>

<body>

<h2>ðŸ“‚ Event Applications</h2>
<div id="applicationsContainer"></div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { getDatabase, ref, onValue, update, get } 
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_DOMAIN",
  databaseURL: "YOUR_DATABASE_URL",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_BUCKET",
  messagingSenderId: "YOUR_ID",
  appId: "YOUR_APP_ID"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const container = document.getElementById("applicationsContainer");

let allEvents = {};
let allApplications = {};
let allUsers = {};
let currentUser = null;


// AUTH CHECK (Admin Only)
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    alert("Login required");
    window.location.href = "admin-login.html";
    return;
  }

  currentUser = user;

  loadData();
});


// FETCH DATA REALTIME
function loadData() {

  onValue(ref(db, "events"), snap => {
    allEvents = snap.val() || {};
    renderApplications();
  });

  onValue(ref(db, "applications"), snap => {
    allApplications = snap.val() || {};
    renderApplications();
  });

  onValue(ref(db, "users"), snap => {
    allUsers = snap.val() || {};
    renderApplications();
  });
}


// RENDER APPLICATIONS
function renderApplications() {

  container.innerHTML = "";

  Object.entries(allEvents).forEach(([eventId, event]) => {

    // Only show events created by this admin
    if (event.createdBy !== currentUser.uid) return;

    const eventDiv = document.createElement("div");
    eventDiv.className = "event-block";

    eventDiv.innerHTML = `<h3>${event.title}</h3>`;

    const eventApps = Object.entries(allApplications)
      .filter(([appId, app]) => app.eventId === eventId);

    if (eventApps.length === 0) {
      eventDiv.innerHTML += "<p>No applications yet.</p>";
    }

    eventApps.forEach(([appId, app]) => {

      const volunteer = allUsers[app.volunteerId];
      if (!volunteer) return;

      const appCard = document.createElement("div");
      appCard.className = "app-card";

      appCard.innerHTML = `
        <div>
          <span class="name-link" onclick="viewProfile('${app.volunteerId}')">
            ${volunteer.name}
          </span>
          <div>Status: ${app.status}</div>
        </div>

        <div>
          <button class="btn accept"
            onclick="updateStatus('${appId}', 'Accepted')">
            Accept
          </button>

          <button class="btn reject"
            onclick="updateStatus('${appId}', 'Rejected')">
            Reject
          </button>
        </div>
      `;

      eventDiv.appendChild(appCard);
    });

    container.appendChild(eventDiv);
  });

}


// ACCEPT / REJECT
window.updateStatus = async function(appId, status) {

  await update(ref(db, "applications/" + appId), {
    status: status
  });

};


// VIEW PROFILE
window.viewProfile = function(uid) {
  window.location.href = "../volunteer/profile.html?uid=" + uid;
};

</script>

</body>
</html>
